version: "3.9"

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Your_strong_password123
    ports:
      - "14333:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost,1433 -U sa -P Your_strong_password123 -C -Q \"SELECT 1\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  authservice:
    build:
      context: ./src/AuthService
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=AuthDb;User Id=sa;Password=Your_strong_password123;TrustServerCertificate=True;
      - Jwt__Key=local-dev-key-change
    depends_on:
      sqlserver:
        condition: service_healthy
    ports:
      - "8080:8080"

  excuse-generator:
    build:
      context: ./src/ExcuseGeneratorService
    container_name: excuse-generator
    ports:
      - "8083:8083"

  excusesservice:
    build:
      context: ./src/ExcusesService
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    depends_on:
      - excuse-generator
    ports:
      - "8081:8081"

    emailservice:
      build:
        context: ./src/EmailService
      environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=http://+:8082
        - Smtp__Host=smtp.sendgrid.net
        - Smtp__Port=587
        - Smtp__UseStartTls=true
        - Smtp__UseSsl=false
        - Smtp__User=apikey
        - Smtp__Password=${SENDGRID_API_KEY}
        - Smtp__From=geradordesculpas@gmail.com
        - Smtp__FromName=Gerador de Desculpas
      ports:
        - "8082:8082"


  gateway:
    build:
      context: ./src/Gateway
    depends_on:
      - authservice
      - excusesservice
      - emailservice
    ports:
      - "8088:8088"